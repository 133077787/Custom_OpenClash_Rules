name: Generate YAML Rules

on:
  push:
    paths:
      - 'rule/*.list'
  workflow_dispatch:

jobs:
  generate-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate YAML from LIST files
        run: |
          FILES=("Custom_Direct" "Custom_Proxy" "Steam_CDN")

          for base_name in "${FILES[@]}"; do
            list_file="rule/${base_name}.list"
            domain_yaml_file="rule/${base_name}_Domain.yaml"
            ip_yaml_file="rule/${base_name}_IP.yaml"
            classical_yaml_file="rule/${base_name}_Classical.yaml"

            timestamp=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')

            domain_rules=$(grep -E '^(DOMAIN-|DOMAIN-SUFFIX|DOMAIN-KEYWORD)' "$list_file" | sed -E "s/^DOMAIN-SUFFIX,(.+)/  - '+.\1'/" | sed -E "s/^DOMAIN-KEYWORD,(.+)/  - '*\1*'/" | sed -E "s/^DOMAIN,(.+)/  - '\1'/")
            ip_rules=$(grep -E '^(IP-|IP-CIDR)' "$list_file" | sed -E "s/^IP-CIDR,([^,]+).*/  - '\1'/" | sed -E "s/^IP,([^,]+).*/  - '\1'/")

            classical_domain_rules=$(grep -E '^(DOMAIN-|DOMAIN-SUFFIX|DOMAIN-KEYWORD)' "$list_file" | sed -E "s/^(.*)/  - \1/")
            classical_ip_rules=$(grep -E '^(IP-|IP-CIDR)' "$list_file" | sed -E "s/^IP-CIDR,([^,]+).*/  - IP-CIDR,\1,no-resolve/" | sed -E "s/^IP,([^,]+).*/  - IP-CIDR,\1,no-resolve/")

            domain_count=$(echo "$domain_rules" | grep -c '  - ' || true)
            ip_count=$(echo "$ip_rules" | grep -c '  - ' || true)
            classical_total=$((domain_count + ip_count))

            generate_file() {
              local file="$1"
              local content="$2"
              local total="$3"
              local tmp="${file}.tmp"

              echo "# Generated from ${list_file}" > "$tmp"
              echo "# REPO: https://github.com/Aethersailor/Custom_OpenClash_Rules" >> "$tmp"
              echo "# SOURCE: https://github.com/Aethersailor/Custom_OpenClash_Rules/blob/main/${list_file}" >> "$tmp"
              echo "# UPDATE: ${timestamp}" >> "$tmp"
              echo "# TOTAL: ${total}" >> "$tmp"
              echo "" >> "$tmp"
              echo "payload:" >> "$tmp"
              echo "$content" >> "$tmp"

              diff_content=$(grep -v '^# UPDATE:' "$tmp")
              if [[ -f "$file" ]]; then
                orig_content=$(grep -v '^# UPDATE:' "$file")
              else
                orig_content=""
              fi

              if [[ "$diff_content" != "$orig_content" ]]; then
                mv "$tmp" "$file"
                git add "$file"
                short_file="$(basename "$file")"
                git commit -m "Generate ${short_file} from $(basename "$list_file")"
              else
                echo "No content changes in ${file}, skip commit."
                rm "$tmp"
              fi
            }

            generate_file "$domain_yaml_file" "$domain_rules" "$domain_count"
            generate_file "$ip_yaml_file" "$ip_rules" "$ip_count"
            generate_file "$classical_yaml_file" "$classical_domain_rules
$classical_ip_rules" "$classical_total"

          done

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n $(git log origin/main..HEAD) ]]; then
            git push origin HEAD:main
          else
            echo "No new commits to push."
          fi
